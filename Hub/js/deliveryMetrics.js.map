{"version":3,"sources":["../src/deliveryMetrics.js"],"names":["VSS","init","explicitNotifyLoaded","usePlatformStyles","client","dados","Array","resultQueryLength","randomColor","opacity","Math","round","random","require","TFS_Wit_WebApi","TFS_Team_WebApi","getClient","myTeam","teamContext","project","getWebContext","name","projectId","id","team","teamId","getTeamFieldValues","then","whereConditions","areaPath","defaultValue","Wiql","query","queryByWiql","ResultQuery","notifyLoadSucceeded","resultQuery","queryType","workItems","length","forEach","getRevisions","workItem","ProcessRevisions","revisions","RevApproved","find","workItemRevision","fields","RevDone","dateApproved","undefined","Date","dateDone","produtionLeadTime","DaysBetween","push","x","toLocaleDateString","y","ShowChart","timeFormat","config","type","data","labels","datasets","label","options","title","display","text","legend","tooltips","callbacks","beforeTitle","afterLabel","scales","xAxes","time","format","scaleLabel","labelString","yAxes","position","gridLines","zeroLineColor","dataset","borderColor","backgroundColor","pointBorderColor","pointBackgroundColor","pointBorderWidth","fill","showLine","Chart","defaults","global","responsive","ctx","document","getElementById","getContext","Scatter","date1","date2","one_day","date1_ms","getTime","date2_ms","difference_ms"],"mappings":"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","file":"deliveryMetrics.js","sourcesContent":["VSS.init({\r\n    explicitNotifyLoaded: true,\r\n    usePlatformStyles: true\r\n});\r\n\r\nvar client = null;\r\nvar dados = new Array();\r\nvar resultQueryLength = 0;\r\nvar randomColor = function(opacity) {\r\n    return 'rgba(' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + (opacity || '.3') + ')';\r\n};\r\n\r\nVSS.require([\"TFS/WorkItemTracking/RestClient\", \"TFS/Work/RestClient\"], function(TFS_Wit_WebApi, TFS_Team_WebApi) {\r\n\r\n    // Get a WIT client to make REST calls to VSTS\r\n    client = TFS_Wit_WebApi.getClient();\r\n    var myTeam = TFS_Team_WebApi.getClient();\r\n    var teamContext = {\r\n        project: VSS.getWebContext().project.name,\r\n        projectId: VSS.getWebContext().project.id,\r\n        team: VSS.getWebContext().team.name,\r\n        teamId: VSS.getWebContext().team.id\r\n    };\r\n\r\n    myTeam.getTeamFieldValues(teamContext).then(areaPath => {\r\n        //criar consulta\r\n        //nocture.dk/2016/01/02/lets-make-a-visual-studio-team-services-extension/\r\n        //blog.joergbattermann.com/2016/05/05/vsts-tfs-rest-api-06-retrieving-and-querying-for-existing-work-items/\r\n        var whereConditions = \"[System.WorkItemType] in ('Product Backlog Item', 'Bug') \" +\r\n            \"AND [System.State] <> 'New' \" +\r\n            \"AND [System.State] <> 'Removed' \" +\r\n            \"AND [System.AreaPath] under '\" + areaPath.defaultValue + \"'\";\r\n\r\n        var Wiql = {\r\n            query: \"SELECT [System.Id],[System.Title] \" +\r\n                \"FROM WorkItems \" +\r\n                //\"WHERE [Microsoft.VSTS.Common.ClosedDate] >= @Today - 90 \" +\r\n                \"WHERE [Microsoft.VSTS.Common.ClosedDate] >= '01/01/2013' \" +\r\n                \"AND [System.State] ever 'Approved' \" +\r\n                \"AND \" + whereConditions\r\n        };\r\n        client.queryByWiql(Wiql).then(ResultQuery);\r\n    });\r\n    VSS.notifyLoadSucceeded();\r\n});\r\n\r\nfunction ResultQuery(resultQuery) {\r\n\r\n    //Clean the variables for each save time\r\n    // intCountDoneWI = new Array();\r\n    // intCountWI = new Array();\r\n    // nWIP = new Array();\r\n\r\n    //ForEach workItem in query, get the respective Revision\r\n    if (resultQuery.queryType == 1) { //flat query\r\n        resultQueryLength = resultQuery.workItems.length;\r\n        if (resultQueryLength > 0) {\r\n            resultQuery.workItems.forEach(workItem => {\r\n                client.getRevisions(workItem.id).then(ProcessRevisions);\r\n            });\r\n        }\r\n    };\r\n\r\n    // if (resultQueryLength == 0) {\r\n    //     formatError();\r\n    //     return WidgetHelpers.WidgetStatusHelper.Success();\r\n    // }\r\n}\r\n\r\nfunction ProcessRevisions(revisions) {\r\n\r\n    var RevApproved = revisions.find(workItemRevision => {\r\n        return workItemRevision.fields[\"System.State\"] == \"Approved\";\r\n    });\r\n\r\n    var RevDone = revisions.find(workItemRevision => {\r\n        return workItemRevision.fields[\"System.State\"] == \"Done\";\r\n    });\r\n\r\n    var dateApproved = (RevApproved != null && RevApproved.fields != undefined) ? new Date(RevApproved.fields[\"System.ChangedDate\"]) : new Date();\r\n    var dateDone = (RevDone != null && RevDone.fields != undefined) ? new Date(RevDone.fields[\"System.ChangedDate\"]) : new Date();\r\n\r\n    var produtionLeadTime = DaysBetween(dateApproved, dateDone)\r\n\r\n    //dados.push({ x: dateDone.getDate(), y: produtionLeadTime });\r\n    dados.push({ x: dateDone.toLocaleDateString(\"pt-BR\"), y: Math.round(produtionLeadTime) });\r\n    if (dados.length == resultQueryLength) {\r\n        ShowChart();\r\n    }\r\n}\r\n\r\nvar timeFormat = 'DD/MM/YYYY';\r\nvar config = {\r\n    type: 'line',\r\n    data: {\r\n        labels: [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\"],\r\n        datasets: [{\r\n            label: \"PBIs\",\r\n        }]\r\n    },\r\n    options: {\r\n        title: {\r\n            display: true,\r\n            text: 'Lead Time'\r\n        },\r\n        legend: {\r\n            display: true //n√£o mostra a lengenda do dataset\r\n        },\r\n        tooltips: {\r\n            //mode: 'single',\r\n            callbacks: {\r\n                beforeTitle: function() {\r\n                    return 'Closed Date:';\r\n                },\r\n                afterLabel: function() {\r\n                    return 'Days';\r\n                },\r\n            }\r\n        },\r\n        scales: {\r\n            xAxes: [{\r\n                display: true,\r\n                type: 'time',\r\n                time: {\r\n                    format: timeFormat\r\n                },\r\n                scaleLabel: {\r\n                    display: false,\r\n                    labelString: 'Date'\r\n                }\r\n            }],\r\n            yAxes: [{\r\n                display: true,\r\n                position: 'left',\r\n                gridLines: {\r\n                    zeroLineColor: \"rgba(0,255,0,1)\"\r\n                },\r\n                scaleLabel: {\r\n                    display: true,\r\n                    labelString: 'Days'\r\n                }\r\n            }]\r\n        }\r\n    }\r\n};\r\n\r\nfunction ShowChart() {\r\n\r\n    config.data.datasets[0].data = dados;\r\n    config.data.datasets.forEach(dataset => {\r\n        dataset.borderColor = randomColor(0.4);\r\n        dataset.backgroundColor = randomColor(0.1);\r\n        dataset.pointBorderColor = randomColor(0.7);\r\n        dataset.pointBackgroundColor = randomColor(0.5);\r\n        dataset.pointBorderWidth = 1;\r\n        dataset.fill = false;\r\n        dataset.showLine = false;\r\n    });\r\n\r\n    Chart.defaults.global.responsive = false;\r\n    var ctx = document.getElementById(\"canvas\").getContext(\"2d\");\r\n\r\n    new Chart.Scatter(ctx, config);\r\n};\r\n\r\n\r\n\r\n\r\nfunction DaysBetween(date1, date2) {\r\n    //Get 1 day in milliseconds\r\n    var one_day = 1000 * 60 * 60 * 24;\r\n\r\n    // Convert both dates to milliseconds\r\n    var date1_ms = date1.getTime();\r\n    var date2_ms = date2.getTime(); //\r\n\r\n    // Calculate the difference in milliseconds\r\n    var difference_ms = date2_ms - date1_ms;\r\n\r\n    // Convert back to days and return\r\n    return Math.round(difference_ms / one_day);\r\n}"]}