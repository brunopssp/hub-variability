<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Delivery Metrics</title>
    <script src="sdk/scripts/polyfill.min.js"></script>
    <script src="sdk/scripts/Chart.bundle.min.js"></script>
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script src="sdk/scripts/jquery.min.js"></script>

</head>

<body>
    <div class="hub-title">
        <div title="Chart of delivery made by Team." class="backlog-page-title-area">Delivery Metrics</div>
    </div>
    <div class="right-hub-content" style="width: 100%; text-align: center; top: 45px">
        <canvas width="888" height="444" id="canvas" style="width: 888px; height: 444px; display: inline;"></canvas>
    </div>
</body>
<script>
    VSS.init({
        explicitNotifyLoaded: true,
        usePlatformStyles: true
    });

    var client = null;
    var myTeam = null;
    var teamContext;
    var dados = new Array();
    var dataSet = new Array();
    var resultQueryLength = 0;
    var state = "New";
    var Avg = 0;
    var DesvP = 0;

    var randomColor = function(opacity) {
        return 'rgba(' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + (opacity || '.3') + ')';
    };
    var timeFormat = 'DD/MM/YYYY';
    var config = {
        type: 'line',
        data: {
            datasets: [{
                label: "Duration",
            }]
        },
        options: {
            title: {
                display: true,
                text: 'Lead Time'
            },
            legend: {
                display: true //n찾o mostra a lengenda do dataset
            },
            tooltips: {
                mode: 'single',
                callbacks: {
                    beforeTitle: function() {
                        return 'Closed Date';
                    },
                }
            },
            scales: {
                xAxes: [{
                    display: true,
                    type: 'time',
                    time: {
                        format: timeFormat,
                        unit: 'week'
                    },
                    scaleLabel: {
                        display: false,
                        labelString: 'Date'
                    }
                }],
                yAxes: [{
                    display: true,
                    position: 'left',
                    gridLines: {
                        zeroLineColor: "rgba(0,255,0,1)"
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Days'
                    }
                }]
            },
            annotation: {
                annotations: [{
                    type: 'line',
                    mode: 'horizontal',
                    scaleID: 'y-axis-1',
                    value: Avg,
                    borderColor: 'red',
                    borderWidth: 2,
                    borderDash: [2, 2]
                }]
            }
        }
    };

    LoadWI();

    function LoadWI() {
        VSS.require(["TFS/WorkItemTracking/RestClient", "TFS/Work/RestClient"], function(TFS_Wit_WebApi, TFS_Team_WebApi) {

            // Get a WIT client to make REST calls to VSTS
            client = TFS_Wit_WebApi.getClient();
            myTeam = TFS_Team_WebApi.getClient();
            teamContext = {
                project: VSS.getWebContext().project.name,
                projectId: VSS.getWebContext().project.id,
                team: VSS.getWebContext().team.name,
                teamId: VSS.getWebContext().team.id
            };

            myTeam.getTeamFieldValues(teamContext).then(function(areaPath) {
                //criar consulta
                client.queryByWiql(GetWiql(areaPath, state)).then(ResultQuery);
            });
        });
    };

    function GetWiql(areaPath, stateEver) {

        //nocture.dk/2016/01/02/lets-make-a-visual-studio-team-services-extension/
        //blog.joergbattermann.com/2016/05/05/vsts-tfs-rest-api-06-retrieving-and-querying-for-existing-work-items/
        var whereConditions = "[System.WorkItemType] in ('Product Backlog Item', 'Bug') " +
            "AND [System.State] <> 'New' " +
            "AND [System.State] <> 'Removed' AND "


        var teamAreaPaths = "([System.AreaPath] under '" + areaPath.values[0].value + "' ";
        for (i = 1; i < areaPath.values.length; i++) {
            teamAreaPaths += " OR [System.AreaPath] under '" + areaPath.values[i].value + "' ";
        }
        whereConditions += teamAreaPaths + ")";
        return Wiql = {
            query: "SELECT [System.Id],[System.Title] " +
                "FROM WorkItems " +
                "WHERE [Microsoft.VSTS.Common.ClosedDate] >= @Today - 90 " +
                //"WHERE [Microsoft.VSTS.Common.ClosedDate] >= '01/01/2013' " +
                "AND [System.State] ever '" + stateEver + "' AND " + whereConditions
        };
    };

    function ResultQuery(resultQuery) {

        //ForEach workItem in query, get the respective Revision
        if (resultQuery.queryType == 1) { //flat query
            resultQueryLength = resultQuery.workItems.length;
            if (resultQueryLength > 0) {
                resultQuery.workItems.forEach(function(workItem) {
                    client.getRevisions(workItem.id).then(ProcessRevisions);
                });
            } else {
                stepStates();
            }
        };
    };

    function ProcessRevisions(revisions) {

        var RevApproved = revisions.find(function(workItemRevision) {
            return workItemRevision.fields["System.State"] == state;
        });

        var RevDone = revisions.find(function(workItemRevision) {
            return workItemRevision.fields["System.State"] == "Done";
        });

        var dateApproved = (RevApproved != null && RevApproved.fields != undefined) ? new Date(RevApproved.fields["System.ChangedDate"]) : new Date();
        var dateDone = (RevDone != null && RevDone.fields != undefined) ? new Date(RevDone.fields["System.ChangedDate"]) : new Date();

        var produtionLeadTime = DaysBetween(dateApproved, dateDone)

        dados.push({
            x: dateDone.toLocaleDateString("pt-BR"),
            y: Math.round(produtionLeadTime)
        });
        if (dados.length == resultQueryLength) {
            Avg = 0;
            var DesvP = 0;

            DesvP = computeStdDeviation(dados); //http://www.investpedia.com.br/artigo/O+que+e+desvio+padrao.aspx
            for (var i = dados.length - 1; i--;) {
                if (dados[i].y > (mean + (DesvP * 2))) dados.splice(i, 1);
            } //Ap처s carregar todos os valores, calcular o desvio padr찾o e excluir itens que est찾o maior que (Media + DesvP*2) antes de carregar dataset
            DesvP = computeStdDeviation(dados);
            dataSet.push({
                label: state,
                data: dados
            });
        }
        stepStates();
    }

    function stepStates() {
        if (state == "New") {
            state = "Approved";
            dados = new Array();
            LoadWI();
        } else
        if (state == "Approved") {
            state = "Committed";
            dados = new Array();
            LoadWI();
        } else
        if (state == "Committed") {
            VSS.notifyLoadSucceeded();
            ShowChart();
        }
    }

    function ShowChart() {

        config.data.datasets = dataSet;
        $.each(config.data.datasets, function(i, dataset) {
            dataset.borderColor = randomColor(0.4);
            dataset.backgroundColor = randomColor(0.1);
            dataset.pointBorderColor = randomColor(0.7);
            dataset.pointBackgroundColor = randomColor(0.5);
            dataset.pointBorderWidth = 1;
            dataset.fill = false;
            dataset.showLine = false;
        });

        Chart.defaults.global.responsive = false;
        var ctx = document.getElementById("canvas").getContext("2d");
        LoadNotations();
        new Chart.Scatter(ctx, config);
    };

    function LoadNotations() {
        config.options.annotation.annotations.push({
            type: 'line',
            mode: 'horizontal',
            scaleID: 'y-axis-1',
            value: Avg + (DesvP),
            borderColor: 'blue',
            borderWidth: 2
        });
        config.options.annotation.annotations.push({
            type: 'line',
            mode: 'horizontal',
            scaleID: 'y-axis-1',
            value: Avg - (DesvP),
            borderColor: 'blue',
            borderWidth: 2
        });
        config.options.annotation.annotations.push({
            type: 'line',
            mode: 'horizontal',
            scaleID: 'y-axis-1',
            value: Avg + (DesvP * 2),
            borderColor: 'green',
            borderWidth: 2
        });
        if (Avg - (DesvP * 2) > 0) {
            config.options.annotation.annotations.push({
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-1',
                value: Avg - (DesvP * 2),
                borderColor: 'green',
                borderWidth: 2
            });
        }
    }

    function DaysBetween(date1, date2) {
        //Get 1 day in milliseconds
        var one_day = 1000 * 60 * 60 * 24;

        // Convert both dates to milliseconds
        var date1_ms = date1.getTime();
        var date2_ms = date2.getTime(); //

        // Calculate the difference in milliseconds
        var difference_ms = date2_ms - date1_ms;

        // Convert back to days and return
        return Math.round(difference_ms / one_day);
    }

    function computeAvg(values) {
        var total = 0;
        for (var i = 0; i < values.length; i++)
            total += values[i].y;
        return total / values.length
    } //http://elemarjr.com/pt/2011/11/11/functional-programming-map-e-reduce-com-javascript/

    function computeStdDeviation(values) {
        Avg = computeAvg(values);
        var total = 0;
        for (var i = 0; i < values.length; i++) {
            var d = values[i].y - Avg;
            total += (d * d);
        }
        return Math.sqrt(total / (values.length - 1));
    }
</script>

</html>